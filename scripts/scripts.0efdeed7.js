"use strict";angular.module("tscorerApp",["ngCookies","ngSanitize","ngRoute","ngAnimate","ngDialog"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"StartCtrl"}).when("/Setup",{templateUrl:"views/setup.html",controller:"SetupCtrl"}).when("/Game",{templateUrl:"views/game.html",controller:"GameCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location",function(a,b){a.$on("$locationChangeStart",function(){a.path=b.path()})}]),angular.module("tscorerApp").controller("SetupCtrl",["$scope","Handicaps","AppSettings","GameSettings","$location",function(a,b,c,d,e){a.gamesettings=d.currentgame,a.setup=c,a.displaySettings={},a.displaySettings.showHcp=!1,a.calculate=function(){var c=b.calculateHandicaps(a.gamesettings.p1.hc,a.gamesettings.p2.hc,a.gamesettings.gameType);a.gamesettings.p1.hcSettings=angular.copy(c.p1),a.gamesettings.p2.hcSettings=angular.copy(c.p2),a.setup.lookupError=c.message,""===c.message&&(a.displaySettings.showHcp=!0)},a.hcpChanged=function(){a.displaySettings.showHcp=!1},a.setServer=function(){"p1"===a.gamesettings.serving?(a.gamesettings.p1.serving=!0,a.gamesettings.p2.serving=!1):(a.gamesettings.p1.serving=!1,a.gamesettings.p2.serving=!0)},a.changeGames=function(){"0"===a.gamesettings.gamesPerSet&&(a.gamesettings.setsPerMatch=0)},a.changeSets=function(){"0"===a.gamesettings.setsPerMatch?a.gamesettings.gamesPerSet="0":"0"===a.gamesettings.gamesPerSet&&(a.gamesettings.gamesPerSet="6")},a.playGame=function(){e.path("Game")}}]),angular.module("tscorerApp").factory("GameSettings",function(){var a={},b={p1:{points:"l",hcSettings:{description:"Love",startingScores:["l","l","l","l"],serves:2,key:"love"},serving:!0},p2:{points:"l",hcSettings:{description:"Love",startingScores:["l","l","l","l"],serves:2,key:"love"},serving:!1},gameType:"Singles",gamesPerSet:"6",setsPerMatch:1,handicap:!0,calculateHcp:!0,playDuece:!1,playAdvantage:!0,serving:"p1"};return a.currentgame=angular.copy(b),a.getdisplaySettings=function(){return{gameType:a.currentgame.gameType,gamesPerSet:a.currentgame.gamesPerSet,setsPerMatch:a.currentgame.setsPerMatch,handicap:a.currentgame.handicap,p1hcp:a.currentgame.p1.hcSettings.description,p2hcp:a.currentgame.p2.hcSettings.description}},a.newgame=function(){a.currentgame=angular.copy(b)},a}),angular.module("tscorerApp").factory("Handicaps",[function(){var a={};a.calculateHandicaps=function(a,d,f){var g,h={};if(h.message="",Number(a)&&Number(d))if(g=Math.round(Math.abs(a-d)),g>c[f])h.message="Maximum handicap difference for "+f+" is "+c[f];else{var i,j,k,l,m;i=b(f,g),Number(a)>=Number(d)?(l="receive",m="owe"):(l="owe",m="receive"),j=e[i[l]],j.key=i[l],k=e[i[m]],k.key=i[m],h.p1=j,h.p2=k,h.message=""}else h.message="Please enter numbers in the handicap fields";return h};var b=function(a,b){for(var c;!c;)c=d[a][b.toString()],b-=1;return angular.copy(c)},c={Singles:50,Doubles:61},d={Singles:{0:{receive:"love",owe:"love"},1:{receive:"love",owe:"owequater15"},2:{receive:"love",owe:"owehalf15"},3:{receive:"rechalf15",owe:"love"},4:{receive:"love",owe:"owe15"},5:{receive:"rechalf15",owe:"owehalf15a"},6:{receive:"rec15",owe:"love"},7:{receive:"rechalf15",owe:"owehalf15"},8:{receive:"rec15",owe:"owehalf15"},9:{receive:"rechalf15",owe:"owehalf30a"},10:{receive:"rec15",owe:"owe15"},11:{receive:"rechalf15",owe:"owe30"},12:{receive:"rec15",owe:"owehalf30"},13:{receive:"rec15",owe:"owe30"},14:{receive:"rechalf30",owe:"owe15"},15:{receive:"rechalf30",owe:"owehalf30a"},16:{receive:"rechalf30",owe:"owe30"},18:{receive:"rec30",owe:"owe15"},20:{receive:"rec30",owe:"owehalf30"},22:{receive:"rec30",owe:"owe30"},24:{receive:"rec30",owe:"owe40"},26:{receive:"rec30",owe:"owe15st"},28:{receive:"rec30",owe:"owehalf30st"},30:{receive:"rec30",owe:"owe30st"},32:{receive:"rec30",owe:"owe40st"},34:{receive:"rec30",owe:"owe15st34"},36:{receive:"rec30",owe:"owehalf30st34"},38:{receive:"rec30",owe:"owe30st34"},40:{receive:"rec30",owe:"owe40st34"},42:{receive:"rec30",owe:"owe30st3"},44:{receive:"rec30",owe:"owe40st3"},46:{receive:"rec30",owe:"owehalf30st23"},48:{receive:"rec30",owe:"owe30st23"},50:{receive:"rec30",owe:"owe40st23"}},Doubles:{0:{receive:"love",owe:"love"},1:{receive:"love",owe:"owequater15"},2:{receive:"love",owe:"owehalf15"},4:{receive:"rechalf15",owe:"love"},5:{receive:"love",owe:"owe15"},6:{receive:"rechalf15",owe:"owehalf15a"},7:{receive:"rec15",owe:"love"},8:{receive:"rechalf15",owe:"owehalf15"},9:{receive:"rec15",owe:"owehalf15"},10:{receive:"rechalf15",owe:"owehalf30a"},11:{receive:"rec15",owe:"owe15"},12:{receive:"rechalf15",owe:"owe30"},13:{receive:"rec15",owe:"owehalf30"},14:{receive:"rec15",owe:"owe30"},15:{receive:"rechalf30",owe:"owe15"},17:{receive:"rechalf30",owe:"owehalf30a"},19:{receive:"rechalf30",owe:"owe30"},21:{receive:"rec30",owe:"owe15"},23:{receive:"rec30",owe:"owehalf30"},25:{receive:"rec30",owe:"owe30"},27:{receive:"rec30",owe:"owe40"},29:{receive:"rec30",owe:"owe15st"},31:{receive:"rec30",owe:"owehalf30st"},33:{receive:"rec30",owe:"owe30st"},35:{receive:"rec30",owe:"owe40st"},37:{receive:"rec30",owe:"owe15st34"},40:{receive:"rec30",owe:"owehalf30st34"},43:{receive:"rec30",owe:"owe30st34"},46:{receive:"rec30",owe:"owe40st34"},49:{receive:"rec30",owe:"owe30st3"},52:{receive:"rec30",owe:"owe40st3"},55:{receive:"rec30",owe:"owehalf30st23"},58:{receive:"rec30",owe:"owe30st23"},61:{receive:"rec30",owe:"owe40st23"}}},e={love:{description:"Love",startingScores:["l","l","l","l"],serves:2},rechalf15:{description:"Receive half 15",startingScores:["l","r1","l","r1"],serves:2},rec15:{description:"Receive 15",startingScores:["r1","r1","r1","r1"],serves:2},rechalf30:{description:"Receive half 30",startingScores:["r1","r2","r1","r2"],serves:2},rec30:{description:"Receive 30",startingScores:["r2","r2","r2","r2"],serves:2},owequater15:{description:"Owe quarter 15",startingScores:["l","l","l","o1"],serves:2},owehalf15:{description:"Owe half 15",startingScores:["l","o1","l","o1"],serves:2},owehalf15a:{description:"Owe half 15",startingScores:["o1","l","o1","l"],serves:2},owe15:{description:"Owe 15",startingScores:["o1","o1","o1","o1"],serves:2},owehalf30:{description:"Owe half 30",startingScores:["o1","o2","o1","o2"],serves:2},owehalf30a:{description:"Owe half 30",startingScores:["o2","o1","o2","o1"],serves:2},owe30:{description:"Owe 30",startingScores:["o2","o2","o2","o3"],serves:2},owe40:{description:"Owe 40",startingScores:["o3","o3","o3","o3"],serves:2},owe15st:{description:"Owe 15 One serve and banned tambour",startingScores:["o1","o1","o1","o1"],serves:1},owehalf30st:{description:"Owe half 30 One serve  banned tambour",startingScores:["o1","o2","o1","o2"],serves:1},owe30st:{description:"Owe 30 One serve and banned tambour",startingScores:["o2","o2","o2","o2"],serves:1},owe40st:{description:"Owe 40 One serve and banned tambour",startingScores:["o3","o3","o3","o3"],serves:1},owe15st34:{description:"Owe 15  One serve and banned tambour and chases worse than 3 & 4. Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o1","o1","o1","o1"],serves:1,chases:3.5},owehalf30st34:{description:"Owe half 30  One serve and banned tambour and chases worse than 3 & 4. Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o1","o2","o1","o2"],serves:1,chases:"threefour"},owe30st34:{description:"Owe 30  One serve and banned tambour and chases worse than 3 & 4. Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o2","o2","o2","o2"],serves:1,chases:"threefour"},owe40st34:{description:"Owe 40  One serve and banned tambour and chases worse than 3 & 4. Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o3","o3","o3","o3"],serves:1,chases:"threefour"},owe30st3:{description:"Owe 30  One serve and banned tambour and chases worse than 3.  Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o2","o2","o2","o2"],serves:1,chases:"three"},owe40st3:{description:"Owe 40 One serve and banned tambour and chases worse than 3.  Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o2","o2","o2","o2"],serves:1,chases:"three"},owehalf30st23:{description:"Owe half 30 One serve and banned tambour and banned chases worse than 2 & 3.  Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o1","o2","o1","o2"],serves:1,chases:"twothree"},owe30st23:{descrtiption:"Owe 30 One serve and banned tambour and banned chases worse than 2 & 3.  Banned hazard chases when playing off chases & Service End is conceded after one chase",startingScores:["o2","o2","o2","o2"],serves:1,chases:"twothree"}};return a}]),angular.module("tscorerApp").factory("AppSettings",function(){var a={};a.gameTypes=["Singles","Doubles"],a.games=[{shortlabel:"5",value:"5"},{shortlabel:"6",value:"6"},{shortlabel:"7",value:"7"},{shortlabel:"8",value:"8"},{shortlabel:"9",value:"9"},{shortlabel:"âˆž",value:"0"}],a.sets=[1,3,5];var b={l:"Love",r1:"Fifteen",r2:"Thirty",r3:"Forty",ad:"Advantage",o1:"Owe Fifteen",o2:"Owe Thirty",o3:"Owe Forty"};a.getScoreLabel=function(a){return b[a]};var c={o3:"-40",o2:"-30",o1:"-15",l:"0",r1:"15",r2:"30",r3:"40",ad:"Ad"};a.getScoreName=function(a){return c[a]};var d=["o3","o2","o1","l","r1","r2","r3"];a.getScoreOrder=function(a){return a&&d.push("ad"),d};var e=[{key:"hone",label:"One yard",shortlabel:"1",choices:[{key:"hbhalf",name:"Better than half a yard",hazard:!0},{key:"hhalf",name:"Half a yard",hazard:!0},{key:"hbtone",name:"Better than one yard",hazard:!0},{key:"hone",name:"One yard",hazard:!0,primary:!0,shortlabel:"1"},{key:"hwtone",name:"Worse than one yard",hazard:!0},{key:"honetwo",name:"One and two",hazard:!0}]},{key:"htwo",label:"Two yards",shortlabel:"2",choices:[{key:"honetwo",name:"One and two",hazard:!0},{key:"hbttwo",name:"Better than two yards",hazard:!0},{key:"htwo",name:"Two yards",hazard:!0,primary:!0,shortlabel:"2"},{key:"hwttwo",name:"Worse than two yards",hazard:!0},{key:"hhalfwttwo",name:"Half a yard worse than two",hazard:!0}]},{key:"hsecond",label:"Second Gallery",shortlabel:"2G",choices:[{key:"hhalfwttwo",name:"Half a yard worse than two",hazard:!0},{key:"hbtsecond",name:"Better than second gallery",hazard:!0},{key:"hsecond",name:"Second gallery",hazard:!0,primary:!0,shortlabel:"2G"},{key:"hwtsecond",name:"Worse than second gallery",hazard:!0},{key:"hywtsecond",name:"A yard worse than second gallery",hazard:!0}]},{key:"hdoor",label:"The door",shortlabel:"D",choices:[{key:"hywtsecond",name:"A yard worse than second gallery",hazard:!0},{key:"hbtdoor",name:"Better than the door",hazard:!0},{key:"hdoor",name:"The door",hazard:!0,primary:!0,shortlabel:"D"},{key:"hwtdoor",name:"Worse than the door",hazard:!0},{key:"hywtdoor",name:"A yard worse than the door",hazard:!0}]},{key:"hfirst",label:"First gallery",shortlabel:"1G",choices:[{key:"hywtdoor",name:"A yard worse than the door",hazard:!0},{key:"hbtfirst",name:"Better than first gallery",hazard:!0},{key:"hfirst",name:"First gallery",hazard:!0,primary:!0,shortlabel:"1G"},{key:"hline",name:"The Line",hazard:!0}]}],f=[{key:"first",label:"First gallery",shortlabel:"1G",choices:[{key:"line",name:"The Line"},{key:"first",name:"First gallery",primary:!0,shortlabel:"1G"},{key:"btfirst",name:"Better than first gallery"},{key:"ywtdoor",name:"A yard worse than the door"}]},{key:"door",label:"The door",shortlabel:"D",choices:[{key:"ywtdoor",name:"A yard worse than the door"},{key:"wtdoor",name:"Worse than the door"},{key:"door",name:"The door",primary:!0,shortlabel:"D"},{key:"btdoor",name:"Better than the door"},{key:"ywtsecond",name:"A yard worse than second gallery"}]},{key:"second",label:"Second gallery",shortlabel:"2G",choices:[{key:"ywtsecond",name:"A yard worse than second gallery"},{key:"wtsecond",name:"Worse than second gallery"},{key:"second",name:"Second gallery",primary:!0,shortlabel:"2G"},{key:"btsecond",name:"Better than second gallery"},{key:"ybtsecond",name:"A yard better than second gallery"},{key:"mtywlast",name:"More than a yard worse than last gallery"},{key:"ywtlast",name:"A yard worse than last gallery"}]},{key:"last",label:"Last gallery",shortlabel:"LG",choices:[{key:"ywtlast",name:"A yard worse than last gallery"},{key:"nywtlast",name:"Nearly a yard worse than last gallery"},{key:"hywtlast",name:"Half a yard worse than last gallery"},{key:"wtlast",name:"Worse than last gallery"},{key:"last",name:"Last gallery",primary:!0,shortlabel:"LG"},{key:"btlast",name:"Better than last gallery"},{key:"halfwtsix",name:"Half a yard worse than six"}]},{key:"six",label:"Six yards",shortlabel:"6",choices:[{key:"halfwtsix",name:"Half a yard worse than six"},{key:"wtsix",name:"Worse than six yards"},{key:"six",name:"Six yards",primary:!0,shortlabel:"6"},{key:"btsix",name:"Better than six yards"},{key:"fivesix",name:"Five and six"}]},{key:"five",label:"Five yards",shortlabel:"5",choices:[{key:"fivesix",name:"Five and six"},{key:"wtfive",name:"Worse than five yards"},{key:"five",name:"Five yards",primary:!0,shortlabel:"5"},{key:"btfive",name:"Better than five yards"},{key:"fourfive",name:"Four and five"}]},{key:"four",label:"Four yards",shortlabel:"4",choices:[{key:"fourfive",name:"Four and five"},{key:"wtfour",name:"Worse than four yards"},{key:"four",name:"Four yards",primary:!0,shortlabel:"4"},{key:"btfour",name:"Better than four"},{key:"threefour",name:"Three and four"}]},{key:"three",label:"Three yards",shortlabel:"3",choices:[{key:"threefour",name:"Three and four"},{key:"wtthree",name:"Worse than three yards"},{key:"three",name:"Three yards",primary:!0,shortlabel:"3"},{key:"btthree",name:"Better than three yards"},{key:"twothree",name:"Two and Three"}]},{key:"two",label:"Two yards",shortlabel:"2",choices:[{key:"twothree",name:"Two and Three"},{key:"wttwo",name:"Worse than two yards"},{key:"two",name:"Two yards",primary:!0,shortlabel:"2"},{key:"bttwo",name:"Better than two yards"},{key:"onetwo",name:"One and two"}]},{key:"one",label:"One yard",shortlabel:"1",choices:[{subkey:"onetwo",name:"One and two"},{subkey:"wtone",name:"Worse than one yard"},{subkey:"one",name:"One yard",primary:!0,shortlabel:"1"},{subkey:"btone",name:"Better than one yard"},{subkey:"half",name:"Half a yard"},{subkey:"bhalf",name:"Better than half a yard"}]}];return a.chases={hazard:e,service:f},a}),angular.module("tscorerApp").controller("GameCtrl",["$scope","$timeout","AppSettings","GameSettings","History","Scoring","ngDialog",function(a,b,c,d,e,f,g){a.gamedata={},a.players={},a.appsettings={},a.players.p1=d.currentgame.p1.name,a.players.p2=d.currentgame.p2.name,a.displaysettings=d.getdisplaySettings(),a.appsettings.chases=c.chases,a.gamedata.logs=e.logs,a.gamedata.notice=e.notice,a.gamedata.lastactions=e.lastactions,a.gamedata.chases=f.chases,a.scores=f.scores,a.gamestate=f.gamestate,a.gamedisplay={},a.gamedisplay.p1={},a.gamedisplay.p2={},a.gamedisplay.gameHasStarted=!1,a.gamedisplay.gameHasEnded=!1,a.gamedisplay.p1.showFault=!1,a.gamedisplay.p2.showFault=!1;var h=[],i=function(a,b){Array.isArray(b)?a.length=b.length:Object.keys(b).forEach(function(c){"object"==typeof b[c]?i(a[c],b[c]):a[c]=b[c]})};a.undo=function(){var b=a.gamedata.lastactions[a.gamedata.lastactions.length-1];e.logUndo({text:b});var c=h[h.length-1];i(a.scores,c.scores),i(a.gamestate,c.gamestate),i(a.gamedisplay,c.gamedisplay),i(a.gamedata,c.gamedata),h.length=h.length-1,a.gamedata.lastactions.length=a.gamedata.lastactions.length-1};var j=function(){var b={};b.gamedata=angular.copy(a.gamedata),delete b.gamedata.logs,delete b.gamedata.lastactions,b.scores=angular.copy(a.scores),b.gamestate=angular.copy(a.gamestate),b.gamedisplay=angular.copy(a.gamedisplay),2===h.length&&h.splice(0,1),h.push(b)},k=function(){a.chasedialog={},a.chasedialog.score=f.getCurrentScore(),g.open({template:"endsdialog.html",scope:a,className:"ts-theme-default"}),f.swapServers(),e.logEnds({chase:a.gamedata.chases[0],chaseCount:a.gamedata.chases.length})},l=function(b){var c={id:b.id,scores:a.scores,playername:a.players[b.id],actions:b.events,extend:b.extend||!1};e.logPoint(c),!b.events.game&&!b.events.set||b.events.match?a.gamedata.chases.length>0&&a.gamestate.playingchase&&e.logSecondChase({chase:a.gamedata.chases[0]}):e.logNewGame({scores:a.scores,players:a.players})};a.awardPoint=function(b){j(),a.gamedisplay.gameHasStarted=!0,a.gamedisplay.p1.showFault=!1,a.gamedisplay.p2.showFault=!1;var c=f.awardPoint(b);l({id:b,events:c}),c.match?a.gamedisplay.gameHasEnded=!0:c.ends&&k()},a.recordFault=function(){j(),a.gamedisplay.gameHasStarted=!0,a.gamedisplay.p1.showFault=!1,a.gamedisplay.p2.showFault=!1;var b=f.recordFault();1===a.gamestate.faults&&(a.gamedisplay[a.gamestate.server].showFault=!0),e.logFault({id:a.gamestate.server,scores:a.scores,actions:b}),b.point&&l({id:a.gamestate.server,events:b,extend:!0})},a.setChase=function(b){a.gamedisplay.showChases=!1,j(),a.gamedisplay.p1.showFault=!1,a.gamedisplay.p2.showFault=!1;var c=f.recordChase(b);e.logChase({id:a.gamestate.server,scores:a.scores,chase:b}),c.ends&&k()},a.showChases=function(b){b?(a.gamedisplay.chases=angular.copy(a.appsettings.chases.hazard),a.gamedisplay.hazardChases=!0):(a.gamedisplay.chases=angular.copy(a.appsettings.chases.service),a.gamedisplay.hazardChases=!1),a.gamedisplay.showChases=!0},a.showChaseChoices=function(b){a.gamedisplay.chases.forEach(function(a){a.showchoices=!1}),b.showchoices=!0},a.$on("showhistory",function(){a.gamedisplay.showHistory=!0,a.gamedisplay.showChases=!1,a.gamedisplay.showSettings=!1}),a.$on("showsettings",function(){a.gamedisplay.showSettings=!0,a.gamedisplay.showHistory=!1,a.gamedisplay.showChases=!1}),a.$on("undo",function(){g.open({template:"undodialog.html",scope:a,className:"ts-theme-default"})}),e.logEvent({evtype:"start",id:"0"}),a.scores=f.initGame(),e.logNewGame({scores:a.scores,players:a.players})}]),angular.module("tscorerApp").filter("matchboolean",function(){return function(a,b,c){var d=[];return angular.isDefined(c)||(c=!0),angular.forEach(a,function(a){(angular.isDefined(a[b])&&a[b]===c||!angular.isDefined(a[b])&&c===!1)&&d.push(a)}),d}}),angular.module("tscorerApp").directive("scrollHelp",["$timeout",function(a){return{restrict:"A",link:function(b,c){c.bind("scroll",function(){a(function(){c[0].scrollTop>angular.element(".scrolltarget").height()-c.height()?(b.showBottomHelp=!1,b.showTopHelp=!0):c.scrollTop()<100?(b.showBottomHelp=!0,b.showTopHelp=!1):(b.showBottomHelp=!1,b.showTopHelp=!1)},500)})}}}]),angular.module("tscorerApp").directive("lastCard",["$timeout",function(a){return{restrict:"A",scope:{chaselength:"=",sizeclass:"="},link:function(b){b.$watch("chaselength",function(c){c&&a(function(){var a=document.getElementById("chasecard"),c=137,d=161;b.sizeclass=a.clientHeight>d?"size3":a.clientHeight>c?"size2":"size1"},100)})}}}]),angular.module("tscorerApp").directive("scrollTop",["$timeout",function(a){return{scope:{trigger:"=",testvalue:"="},restrict:"A",link:function(b,c){b.$watch("trigger",function(b){b&&a(function(){c[0].scrollTop=1e4},200)})}}}]),angular.module("tscorerApp").controller("StartCtrl",["$scope","$location",function(a,b){a.startGame=function(){b.path("Setup")}}]),angular.module("tscorerApp").controller("HeaderCtrl",["$scope","$rootScope",function(a,b){a.showmenu=!1,a.toggleMenu=function(){a.showmenu=!a.showmenu},a.showHistory=function(){b.$broadcast("showhistory")},a.showSettings=function(){b.$broadcast("showsettings")},b.$on("$locationChangeStart",function(){a.showmenu=!1}),a.undo=function(){b.$broadcast("undo")}}]),angular.module("tscorerApp").factory("History",function(){var a={};a.logs=[],a.notice={text:""},a.lastactions=[];var b={start:"Match Begins"};return a.logEvent=function(c){var d,e=c.evtype;d=b[e],a.logs.push({action:e,player:"0",text:d,scoretext:"",scores:{},extend:!1}),a.notice.text=d},a.logNewGame=function(b){var c="Game Starts - "+b.players.p1+": "+b.scores.p1.pointlabel+", "+b.players.p2+": "+b.scores.p2.pointlabel;a.logs.push({action:"init",player:"0",text:c,scoretext:"",scores:b.scores,extend:!1})},a.logPoint=function(b){var c="p2",d="",e="",f="",g="",h=[],i={},j=b.actions||{},k=b.extend||!1;"p2"===b.id&&(c="p1"),j.game&&(f="Game",e=b.scores[b.id].games+" / "+b.scores[c].games,h.push("game")),j.set&&(f="Game, Set",h.push("set"),e=b.scores[b.id].sets+" / "+b.scores[c].sets),j.match&&(f="Game, Set, Match",h.push("match")),""===f?(d="Point to "+b.playername,g=d,e=b.scores[b.id].pointname+" - "+b.scores[c].pointname,f=b.scores[b.id].pointlabel+" - "+b.scores[c].pointlabel,b.scores[b.id].pointlabel===b.scores[c].pointlabel&&(f=b.scores[c].pointlabel+" all")):(d="Point to "+b.playername+", "+f,g=d+". "+f),i={action:"point",player:"0",text:d,scoretext:e,scores:b.scores,extend:k},h.length>0&&(i.more=h),a.logs.push(i),a.notice.text=f,k?a.lastactions[a.lastactions.length-1]+=", "+g:(2===a.lastactions.length&&a.lastactions.splice(0,1),a.lastactions.push(g))},a.logFault=function(b){var c="Fault",d=b.actions||{};d.point&&(c="Double Fault"),a.logs.push({action:"fault",player:b.id,text:c,scoretext:"",scores:b.scores,extend:!1}),2===a.lastactions.length&&a.lastactions.splice(0,1),a.lastactions.push(c),a.notice.text=c},a.logChase=function(b){var c="Chase "+b.chase.name.toLowerCase();b.chase.hazard&&(c="Hazard "+c.toLowerCase()),a.logs.push({action:"chase",player:b.id,text:c,scoretext:"",scores:b.scores,extend:!1}),2===a.lastactions.length&&a.lastactions.splice(0,1),a.lastactions.push(c),a.notice.text=c},a.logEnds=function(b){var c="Change of ends: play ",d="chase "+b.chase.name.toLowerCase();b.chase.hazard&&(d="hazard "+d),a.logs.push({action:"chase",player:"0",text:c+d,scoretext:"",scores:b.scores,extend:!0}),a.lastactions[a.lastactions.length-1]+=", "+c.toLowerCase()+d,a.notice.text+=2===b.chaseCount?", "+c.toLowerCase()+d:", change of ends"},a.logSecondChase=function(b){var c=". Second chase: ",d=b.chase.name.toLowerCase();b.chase.hazard&&(d="hazard "+d);var e=a.logs[a.logs.length-1];e.text+=c+d,a.lastactions[a.lastactions.length-1]+=c+d,a.notice.text+=c+d},a.logUndo=function(b){var c=b.text;c.indexOf(": ")>0&&(c=c.substring(0,c.indexOf(": "))),c.indexOf(". ")>0&&(c=c.substring(0,c.indexOf(". "))),a.logs.push({action:"undo",player:"0",text:"Undo "+c,scoretext:"",scores:b.scores,extend:!0})},a}),angular.module("tscorerApp").factory("Scoring",["GameSettings","AppSettings",function(a,b){var c={},d={},e={},f={},g=[];e.p1=a.currentgame.p1,e.p2=a.currentgame.p2,d.p1={sets:0,games:0,points:""},d.p2={sets:0,games:0,points:""},f.game=0,f.faults=0,f.playingchase=!1,f.gamepoint=!1,e.p1.serving?(f.server="p1",f.receiver="p2"):(f.server="p2",f.receiver="p1"),c.initGame=function(){return d.p1.points=e.p1.hcSettings.startingScores[f.game%4],d.p2.points=e.p2.hcSettings.startingScores[f.game%4],h(),d};var h=function(){d.p1.pointname=b.getScoreName(d.p1.points),d.p1.pointlabel=b.getScoreLabel(d.p1.points),d.p2.pointname=b.getScoreName(d.p2.points),d.p2.pointlabel=b.getScoreLabel(d.p2.points)};c.awardPoint=function(a){var c,e,j,k={},l=!1,m=!1;return c=d[a].points,e=b.getScoreOrder(),j=e.indexOf(d[a].points),f.faults=0,f.playingchase&&(g.splice(0,1),0===g.length&&(f.playingchase=!1)),c===e[e.length-1]?(f.gamepoint=!1,l=!0):(j++,d[a].points=e[j],j+1===e.length&&(f.gamepoint=!0,g.length>0&&!f.playingchase&&(m=!0))),l&&(k=i(a)),m&&(k.ends=!0),h(),k};var i=function(b){var e={};return d[b].games=d[b].games+1,d[b].games===Number(a.currentgame.gamesPerSet)?(e=j(b),f.game=0):f.game+=1,e.game=!0,c.initGame(),e},j=function(b){var c={};return d[b].sets=d[b].sets+1,d[b].sets===Number(a.currentgame.setsPerMatch)&&(c=k(b)),c.set=!0,d.p1.games=0,d.p2.games=0,c},k=function(){var a={};return a.match=!0,a};c.recordFault=function(){var a=f.server,b={};return 1===e[a].hcSettings.serves?(b=c.awardPoint(f.receiver),b.point=!0):1===f.faults?(b=c.awardPoint(f.receiver),b.point=!0):f.faults=1,b.fault=!0,b},c.recordChase=function(a){var b={},c=g.length;return g.push(angular.copy(a)),g[c].description=a.name,a.hazard&&(g[c].description="Hazard chase "+a.name.toLowerCase()),(2===g.length||f.gamepoint)&&(b.ends=!0),b},c.getCurrentScore=function(c){var e={},f="",g="",h="";return c?(e.p1=b.getScoreName(d.p1.points),e.p2=b.getScoreName(d.p2.points)):(e.p1=b.getScoreLabel(d.p1.points),e.p2=b.getScoreLabel(d.p2.points)),"r3"===d.p1.points&&"r3"===d.p2.points&&(g=a.currentgame.playAdvantage?"40 all, game point":"Duece"),h=l(),g=e.p1===e.p2?e.p1+" all":"p1"===h?e.p1+" - "+e.p2+f:e.p2+" - "+e.p1+f};var l=function(){var a="p1",c=b.getScoreOrder(),e=c.indexOf(d.p1.points),f=c.indexOf(d.p2.points);return e===f?a="":f>e&&(a="p2"),a};return c.swapServers=function(){var a=f.server;f.server=f.receiver,f.receiver=a,g.length>0&&(f.playingchase=!0)},c.scores=d,c.players=e,c.gamestate=f,c.chases=g,c}]);